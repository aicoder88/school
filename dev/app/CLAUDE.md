# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

"Murder on the Bullet Express" is a production-ready educational browser game built with Next.js 15, TypeScript, Phaser 3, and Supabase. It's an ESL (English as a Second Language) detective mystery game for students aged 12-15 with real-time teacher-student collaboration.

## Essential Commands

### Development
```bash
npm run dev           # Start development server (http://localhost:3000)
npm run build         # Build for production 
npm run start         # Start production server
npm run lint          # Run ESLint
npm run type-check    # TypeScript type checking (tsc --noEmit)
```

### Testing the Game
- Student Interface: `http://localhost:3000/menu` 
- Teacher Dashboard: `http://localhost:3000/conductor`
- Test with room codes generated by teachers

## Architecture & Key Technologies

### Core Stack
- **Frontend**: Next.js 15 with App Router, React 19, TypeScript, Tailwind CSS
- **Game Engine**: Phaser 3.85.2 for interactive point-and-click gameplay
- **Backend**: Supabase (PostgreSQL + Realtime + Auth) for multiplayer sync
- **State Management**: Zustand for React state, custom GameManager for Phaser
- **Styling**: Tailwind CSS with custom steampunk theme colors

### Critical Architecture Components

#### 1. Real-time Multiplayer System
- **Supabase Realtime**: Synchronizes game state between teacher and student
- **GameStore** (`src/stores/gameStore.ts`): Zustand store managing room state, chat, journal
- **GameManager** (`src/game/GameManager.ts`): Bridge between Phaser scenes and Supabase
- **Database Schema**: Tables for `rooms`, `journal_entries`, `chat` with RLS policies

#### 2. Game Engine Integration
- **Scene Architecture**: Boot → Menu → Carriage → Mini-games → Accuse → Debrief
- **PhaserGame Component** (`src/components/PhaserGame.tsx`): React-Phaser bridge
- **Scene Communication**: Scenes communicate via GameManager and emit events to React

#### 3. Dual Interface System
- **Student Interface** (`src/app/play/page.tsx`): Game canvas + inventory/journal panels
- **Teacher Controls** (`src/app/conductor/page.tsx`): Dashboard with scene control, broadcast messages
- **Role Detection**: URL-based (`/play` vs `/conductor`) with `isTeacher` state management

### Important File Locations

#### Game Engine
- `src/game/scenes/` - Phaser 3 game scenes (CarriageScene, MiniGames, etc.)
- `src/game/GameManager.ts` - Central game state coordinator
- `src/data/case_01.json` - Case data (suspects, clues, dialogue trees)

#### React Components
- `src/components/PhaserGame.tsx` - Main game canvas wrapper
- `src/components/StudentInterface.tsx` - Student UI panels
- `src/components/TeacherControls.tsx` - Teacher dashboard controls

#### Data Layer  
- `src/lib/supabase.ts` - Supabase client configuration
- `src/types/database.ts` - Generated Supabase types
- `src/types/game.ts` - Game-specific TypeScript interfaces

### Key Patterns

#### State Synchronization
```typescript
// GameStore handles React state + Supabase integration  
const useGameStore = create<GameStore>((set, get) => ({
  setupRealTimeSubscription: (roomId) => {
    // Subscribes to room updates, journal, chat
  }
}))

// GameManager handles Phaser state + scene transitions
class GameManager {
  private handleRoomUpdate(roomData: any) {
    // Updates gameState and notifies current scene
  }
}
```

#### Teacher-Student Communication
- **Room Codes**: 6-character codes for session joining
- **Scene Control**: Teachers can change scenes, lock/unlock interaction
- **Broadcast System**: Teachers send messages as "Conductor Whibury"
- **Real-time Sync**: All interactions logged to journal, visible to both parties

## Environment Setup

### Required Environment Variables
```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Game Assets
Place in `public/` directory:
- `images/` - Sprites, backgrounds, UI elements
- `audio/` - OGG format sound files  
- `icons/` - PWA icons (72x72 to 512x512)

## Development Notes

### Supabase Database Schema
The game requires specific tables with RLS policies. Reference the comprehensive SQL schema in `README.md` lines 77-151.

### Audio/Media Handling  
- Webpack configured for audio files (`.ogg`, `.mp3`, `.wav`)
- Images optimized with WebP format support
- Custom file-loader outputs to `_next/static/sounds/`

### TypeScript Configuration
- Strict mode enabled
- Path alias: `@/*` maps to `./src/*`
- Next.js plugin for enhanced IDE support

### Phaser-React Integration
- Game instance stored on `globalThis.game`
- React components communicate with Phaser via GameManager
- Scene transitions controlled through Supabase room state updates

## Common Development Tasks

### Adding New Game Scenes
1. Create scene class in `src/game/scenes/`
2. Register in `GameManager.getScenes()`
3. Add scene navigation logic to teacher controls
4. Update TypeScript types if needed

### Modifying Case Content
1. Edit `src/data/case_01.json` for suspects, dialogue, clues
2. Update corresponding TypeScript interfaces in `src/types/`
3. Test dialogue trees and mini-game triggers

### Extending Realtime Features
1. Add new Supabase table/columns
2. Update database types in `src/types/database.ts`
3. Extend GameStore with new subscription channels
4. Add corresponding UI components for new data

### PWA Configuration
- Manifest: `public/manifest.json`
- Service Worker: `src/app/sw.js`
- Install prompt: `src/components/PWAInstallPrompt.tsx`